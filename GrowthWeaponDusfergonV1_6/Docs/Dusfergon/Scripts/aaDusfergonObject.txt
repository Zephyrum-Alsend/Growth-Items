scn aaDusfergonObject

;Main script
;-----------------------------------------------------------------------------
;aaDusfergonManager
;-----------------------------------------------------------------------------

;Used scripts
;-----------------------------------------------------------------------------
;aaDusfergonOnHit
;aaDusfergonOnBowHit
;aaDusfergonOnArrowHit
;-----------------------------------------------------------------------------

;Related scripts
;-----------------------------------------------------------------------------
;aaDusfergonObjectB
;aaDusfergonObjectS
;-----------------------------------------------------------------------------

;Used globals
;-----------------------------------------------------------------------------
;aaDusfergonEquip
;aaDusfergonBroken
;aaDusfergonArrowsUp
;-----------------------------------------------------------------------------

;Related globals
;-----------------------------------------------------------------------------
;-----------------------------------------------------------------------------

;Description
;-----------------------------------------------------------------------------
;Un/sets Equip flag and OnHitWith event handler when un/equipping the weapon.
;Removes all handlers and unsets Equip when removed from Player inventory.
;-----------------------------------------------------------------------------

;Parameters
;-----------------------------------------------------------------------------
array_var Stack

ref Item
;-----------------------------------------------------------------------------



;-----------------------------------------------------------------------------
begin OnUnEquip Player
;-----------------------------------------------------------------------------

	Set aaDusfergonEquip to 0
	RemoveEventHandler "OnHitWith" aaDusfergonOnHit

	;-----------------------------------------------------------------------------
	;Check if broken
	;-----------------------------------------------------------------------------
	Let Stack := Player.GetInvRefsForItem DLScalar3
	Let Item := Stack[0]
	if ( Item.GetRefCount > 0 && Item.GetCurrentHealth <= 0 )

		Set aaDusfergonBroken to 1

	endif
	
;-----------------------------------------------------------------------------
end ;OnUnequip Player
;-----------------------------------------------------------------------------



;-----------------------------------------------------------------------------
begin OnEquip Player
;-----------------------------------------------------------------------------

	Set aaDusfergonEquip to 1
	;GetSelf rarely returns the ID of the Player instead of the object, so we hardcode the ObjectID.
	SetEventHandler "OnHitWith" aaDusfergonOnHit "object"::DLScalar3

;-----------------------------------------------------------------------------
end ;OnEquip Player
;-----------------------------------------------------------------------------


;-----------------------------------------------------------------------------
begin OnDrop Player
;-----------------------------------------------------------------------------

	Set aaDusfergonEquip to 0
	Set aaDusfergonArrowsUp to 0
	RemoveEventHandler "OnHitWith" aaDusfergonOnHit
	RemoveEventHandler "OnRelease" aaDusfergonOnBowHit
	RemoveEventHandler "OnHitWith" aaDusfergonOnArrowHit

;-----------------------------------------------------------------------------
end ;OnDrop Player
;-----------------------------------------------------------------------------