scn aaDusfergonWeaponEat

;Main script
;-----------------------------------------------------------------------------
;aaDusfergonManger
;-----------------------------------------------------------------------------

;Used scripts
;-----------------------------------------------------------------------------
;aaDusfergonRefreshInv
;aaDUsfergonXPReport
;-----------------------------------------------------------------------------

;Related scripts
;-----------------------------------------------------------------------------
;-----------------------------------------------------------------------------

;Used globals
;-----------------------------------------------------------------------------
;aaDusfergonLevel
;aaDusfergonXP
;-----------------------------------------------------------------------------

;Related globals
;-----------------------------------------------------------------------------
;-----------------------------------------------------------------------------

;Description
;-----------------------------------------------------------------------------
;-----------------------------------------------------------------------------

;Parameters
;-----------------------------------------------------------------------------
short LvlCap
short Eater ;Return value
float Absor
short XPGain
short Health
short Count

string_var Prompt
string_var Name
string_var Icon

array_var Stack

ref Weap
ref Item
ref Temp
;-----------------------------------------------------------------------------



;-----------------------------------------------------------------------------
begin Function { LvlCap, Eater, Weap, Name, Icon, Absor }
;-----------------------------------------------------------------------------

	;-----------------------------------------------------------------------------
	;Get the Player's response
	;-----------------------------------------------------------------------------
	if ( aaDusfergonInit.Button < 0 )

		Set aaDusfergonInit.Button to GetButtonPressed

	endif



	;-----------------------------------------------------------------------------
	;If at or exceeding sLevelCap, refuse to eat
	;-----------------------------------------------------------------------------
	if ( aaDusfergonLevel >= LvlCap )
	;-----------------------------------------------------------------------------
	
		Let Prompt := Name + " has no need for further offerings."		
		MessageBox $Prompt

		Set Eater to 0
		
	;-----------------------------------------------------------------------------
	;Confirm with Player if they really want to feed Weap to weapon
	;-----------------------------------------------------------------------------
	elseif ( Eater == 1 )
	;-----------------------------------------------------------------------------
	
		Set Prompt to sv_Construct "Do you want to offer %n to %z?" Weap Name
		MessageBox $Prompt "Yes" "No"

		Set Eater to 2

	;-----------------------------------------------------------------------------
	;Feed Weap to weapon
	;-----------------------------------------------------------------------------
	elseif ( Eater == 2 && aaDusfergonInit.Button > -1 )
	;-----------------------------------------------------------------------------
	
		;-----------------------------------------------------------------------------
		;Button == Yes
		;-----------------------------------------------------------------------------
		if ( aaDusfergonInit.Button == 0 )

			;State item's consumption and play item break SFX
			SetMessageIcon $Icon
			SetMessageSound UIArmorWeaponRepairBreak
			MessageEX "%z consumes %n." Name Weap

			;Get inventory references and durability
			Let Stack := Player.GetInvRefsForItem Weap
			Let Item := Stack[0]
			Let Health := Item.GetCurrentHealth
			Let Count := Item.GetRefCount

			;Calculate XPGain
			Let XPGain := Absor * Health

			;Item is invalid from this point onwards
			Item.RemoveMeIR
			
			
			;RemoveMeIR removed the entire stack, so add back all but 1
			if ( Count > 1 )
				Let Count := Count - 1
				
				Let Temp := CreateTempRef Weap
				Temp.SetRefCount Count
				Temp.SetCurrentHealth Health
				Temp.CopyIR PlayerRef

				Let Temp := 0

			endif

			
			Call aaDusfergonRefreshInv

			Let aaDusfergonXP := aaDusfergonXP + XPGain

			;If combat logger is active, make sure we aren't counted
			if ( aaDusfergonCombatXPLog == 1 )

				Let aaDusfergonCombatXPStart := aaDusfergonCombatXPStart + XPGain

			endif

			;-----------------------------------------------------------------------------
			Let Prompt := $Weap + " consumed."
			Call aaDusfergonXPReport XPGain Prompt
			;-----------------------------------------------------------------------------

		;-----------------------------------------------------------------------------
		endif ;( Button == Yes )
		;-----------------------------------------------------------------------------
	
		Set Eater to 0
		
	;-----------------------------------------------------------------------------
	endif ;( Level < sLevelCap && Eater > 0 )
	;-----------------------------------------------------------------------------
	

	sv_Destruct Prompt
	SetFunctionValue Eater
	Return
;-----------------------------------------------------------------------------
end ;Function { LvlCap, Eater, Weap, Name, Icon, Absor }
;-----------------------------------------------------------------------------